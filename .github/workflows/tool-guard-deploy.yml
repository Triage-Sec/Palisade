name: Tool Guard Deploy

on:
  push:
    tags:
      - "tool-guard-dev@*"
      - "tool-guard-prod@*"

jobs:
  deploy-dev:
    if: startsWith(github.ref, 'refs/tags/tool-guard-dev@')
    runs-on: ubuntu-latest
    environment: Tool Guard Dev
    env:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-west-1
      CLICKHOUSE_DSN: ${{ secrets.CLICKHOUSE_DSN }}
      POSTGRES_DSN: ${{ secrets.POSTGRES_DSN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Build and push Tool Guard Docker image
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#tool-guard-dev@}"
          echo "Deploying Tool Guard version: ${VERSION}"
          chmod +x services/tool_guard/scripts/create_docker.sh
          services/tool_guard/scripts/create_docker.sh "$VERSION"

      - name: Deploy to dev
        working-directory: services/tool_guard/deploy
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#tool-guard-dev@}"
          pnpm install
          VERSION="$VERSION" npx cdk bootstrap aws://${{ env.AWS_ACCOUNT_ID }}/us-west-1
          VERSION="$VERSION" CLICKHOUSE_DSN="${{ env.CLICKHOUSE_DSN }}" \
            POSTGRES_DSN="${{ env.POSTGRES_DSN }}" \
            VPC_ID="${{ env.VPC_ID }}" \
            npx cdk deploy palisade-tool-guard-dev \
            --require-approval never \
            --progress events

  deploy-prod:
    if: startsWith(github.ref, 'refs/tags/tool-guard-prod@')
    runs-on: ubuntu-latest
    environment: Tool Guard Prod
    env:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-west-1
      CLICKHOUSE_DSN: ${{ secrets.CLICKHOUSE_DSN }}
      POSTGRES_DSN: ${{ secrets.POSTGRES_DSN }}
      VPC_ID: ${{ secrets.VPC_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Build and push Tool Guard Docker image
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#tool-guard-prod@}"
          echo "Deploying Tool Guard version: ${VERSION}"
          chmod +x services/tool_guard/scripts/create_docker.sh
          services/tool_guard/scripts/create_docker.sh "$VERSION"

      - name: Deploy to prod
        working-directory: services/tool_guard/deploy
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#tool-guard-prod@}"
          pnpm install
          VERSION="$VERSION" npx cdk bootstrap aws://${{ env.AWS_ACCOUNT_ID }}/us-west-1
          VERSION="$VERSION" CLICKHOUSE_DSN="${{ env.CLICKHOUSE_DSN }}" \
            POSTGRES_DSN="${{ env.POSTGRES_DSN }}" \
            VPC_ID="${{ env.VPC_ID }}" \
            npx cdk deploy palisade-tool-guard-prod \
            --require-approval never \
            --progress events
