name: Prompt Guard Deploy

on:
  push:
    tags:
      - "prompt-guard-dev@*"
      - "prompt-guard-prod@*"

jobs:
  deploy-dev:
    if: startsWith(github.ref, 'refs/tags/prompt-guard-dev@')
    runs-on: ubuntu-latest
    environment: Prompt Guard Dev
    env:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-west-1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Build and push Docker image
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#prompt-guard-dev@}"
          echo "Deploying version: ${VERSION}"
          chmod +x services/prompt_guard/scripts/create_docker.sh
          services/prompt_guard/scripts/create_docker.sh "$VERSION"

      - name: Deploy to dev
        working-directory: services/prompt_guard/deploy
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#prompt-guard-dev@}"
          pnpm install
          VERSION="$VERSION" npx cdk bootstrap aws://${{ env.AWS_ACCOUNT_ID }}/us-west-1
          VERSION="$VERSION" VPC_ID="${{ secrets.VPC_ID }}" \
            npx cdk deploy palisade-prompt-guard-dev \
            --require-approval never \
            --progress events

  deploy-prod:
    if: startsWith(github.ref, 'refs/tags/prompt-guard-prod@')
    runs-on: ubuntu-latest
    environment: Prompt Guard Prod
    env:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-west-1
      VPC_ID: ${{ secrets.VPC_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Build and push Docker image
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#prompt-guard-prod@}"
          echo "Deploying version: ${VERSION}"
          chmod +x services/prompt_guard/scripts/create_docker.sh
          services/prompt_guard/scripts/create_docker.sh "$VERSION"

      - name: Deploy to prod
        working-directory: services/prompt_guard/deploy
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#prompt-guard-prod@}"
          pnpm install
          VERSION="$VERSION" npx cdk bootstrap aws://${{ env.AWS_ACCOUNT_ID }}/us-west-1
          VERSION="$VERSION" VPC_ID="${{ env.VPC_ID }}" \
            npx cdk deploy palisade-prompt-guard-prod \
            --require-approval never \
            --progress events
